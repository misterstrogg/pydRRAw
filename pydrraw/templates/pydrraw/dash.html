{% extends "base.html" %}
{% block content %}
{% load mathfilters %}

<section class="demo">
  <div class="gridster">
	<ul>
    {% for dobject in dobjects %}
      {% if dobject.type == 'S' %} 
	{% url 'pydrraw:drawgraph' dobject.graphid as graphurl %}
        <li id="{{ forloop.counter }}" data-row='1' data-col='1' data-alttext='{{ graphurl }}' data-gtype='{{ dobject.type }}' data-graphid={{ dobject.graphid }} data-timelagratio={{ dobject.timelagratio }} data-sizex="{{ dobject.widthratio }}" data-sizey="{{ dobject.heightratio }}"></li>
      {% else %}
        <li id="{{ forloop.counter }}" data-row='1' data-col='1' data-alttext='{{ dobject.alttext }}' data-gtype='{{ dobject.type }}' data-graphid={{ dobject.graphid }} data-timelagratio={{ dobject.timelagratio }} data-sizex="{{ dobject.widthratio }}" data-sizey="{{ dobject.heightratio }}"></li>
      {% endif %}
    {% empty %}
	<li> No Dash Items Found </li>
    {% endfor %}
	  </ul></div>


<H2>{{ dinfo.title }}:{{ dinfo.desc }}</H2>
</section>

{% endblock %}
{% block script %}
<script type="text/javascript">
$(window).ready(function () {
	var localData;
	localData = JSON.parse(localStorage.getItem('griddata'));
	var serverlayout={{ dinfo.serialized_layout|safe }};
	if(localData==null)  {
		//localData=JSON.parse(serverlayout);
		localData=serverlayout;
	}
//	}
	if(localData!=null) {
		$.each(localData, function(i,value){
    			var id_name;
			id_name="#";
			id_name = id_name + value.id;
			$(id_name).attr({"data-col":value.col, "data-row":value.row, "data-sizex":value.size_x, "data-sizey":value.size_y});
			newwidth =  {{ dinfo.width }} * ($(id_name)[0].dataset.sizex);
			newheight =  {{ dinfo.height }} * ($(id_name)[0].dataset.sizey);
			newstart = parseInt(({{ dinfo.end }} - {{ dinfo.start }}) * 
			   ($(id_name)[0].dataset.timelagratio) * (-1) + {{ dinfo.end }}); 
			var fc = '{{ dinfo.forcecolor }}';
			if ($(id_name)[0].dataset.gtype == 'S') {
			rawgraphurl = $(id_name)[0].dataset.alttext + '?' 
			timeurlappend = '&start=' + newstart + '&end=' + {{ dinfo.end }};
			sizeurlappend = '&height=' + newheight + '&width=' + newwidth;
			styleurlappend = '&nolegend=1&fullsizemode=1&graphonly={{ dinfo.graphonly }}';
			  if (fc == 'True') {
				styleurlappend+='&cs={{ dinfo.cs }}';
			  }
			} else {
			rawgraphurl = $(id_name)[0].dataset.alttext 
			timeurlappend = '&from=' + newstart + '&until=' + {{ dinfo.end }};
			sizeurlappend = '&height=' + newheight + '&width=' + newwidth;
			styleurlappend = '&hideLegend=1&graphOnly={{ dinfo.graphonly }}';
			  if (fc == 'True') {
				//main colors want no leading #
				styleurlappend+='&bgcolor=' + '{{ csobj.cback }}'.substring(1);
				styleurlappend+='&fgcolor=' + '{{ csobj.cfont }}'.substring(1);
				styleurlappend+='&majorGridLineColor=' + '{{ csobj.cmgrid }}';
			  }
			}
			imageurl = rawgraphurl + sizeurlappend + timeurlappend + styleurlappend;
			linkurl = rawgraphurl + timeurlappend + '&height=' + $(window).height() + '&width=' + $(window).width();;
			$(id_name)[0].innerHTML = "<img src=\"" + imageurl +  "\" ondblclick=parent.location='" + linkurl + "'><span class='gs-resize-handle gs-resize-handle-both'></span> ";
			//$(id_name)[0].innerHTML = "<img src=\"" + newgraphurl +  "\"/><span class='gs-resize-handle gs-resize-handle-both'></span> ";

		});
	} else {
		console.log('No data returned by the server: ' + localData);	
		console.log('btw: ' + serverlayout);	
	}
});
$(function () { //DOM Ready

    $(".gridster ul").gridster({
        widget_margins: [2, 2],
        widget_base_dimensions: [({{ dinfo.width }} - 2), ({{ dinfo.height }} - 2)],
	max_columns: {{ dinfo.columns }},
	helper: 'clone',
	avoid_overlapped_widgets: true,
	resize: {
	   enabled: true,
	   stop: function(event, ui) {
		elid = this.$el.context.lastElementChild.id;
		newwidth =  parseInt(this.resize_initial_width, 10) / parseInt(this.resize_initial_sizex, 10) * parseInt(this.resize_last_sizex, 10);
		newheight =  parseInt(this.resize_initial_height, 10) / parseInt(this.resize_initial_sizey, 10) * parseInt(this.resize_last_sizey, 10);
		newstart = parseInt(({{ dinfo.end }} - {{ dinfo.start }}) * (this.$resized_widget[0].dataset.timelagratio) * (-1) + {{ dinfo.end }}); //weird math is just to mirror fuxor mathfilters math above
		console.log(this);
			var fc = '{{ dinfo.forcecolor }}';
		if (this.$resized_widget[0].dataset.gtype == 'S') {
			rawgraphurl = this.$resized_widget[0].dataset.alttext + '?';
			timeurlappend = '&start=' + newstart + '&end=' + {{ dinfo.end }};
			sizeurlappend = '&height=' + newheight + '&width=' + newwidth;
			styleurlappend = '&nolegend=1&fullsizemode=1&graphonly={{ dinfo.graphonly }}';
			  if (fc == 'True') {
				styleurlappend+='&cs={{ dinfo.cs }}';
			  }
		} else {
			rawgraphurl = this.$resized_widget[0].dataset.alttext;
			timeurlappend = '&from=' + newstart + '&until=' + {{ dinfo.end }};
			sizeurlappend = '&height=' + newheight + '&width=' + newwidth;
			styleurlappend = '&hideLegend=1&graphOnly={{ dinfo.graphonly }}';
			  if (fc == 'True') {
				styleurlappend+='&bgcolor=' + '{{ csobj.cback }}'.substring(1);
				styleurlappend+='&fgcolor=' + '{{ csobj.cfont }}'.substring(1);
				styleurlappend+='&majorGridLineColor=' + '{{ csobj.cmgrid }}';
			  }
		}
		imageurl = rawgraphurl + sizeurlappend + timeurlappend + styleurlappend;
		linkurl = rawgraphurl + '&height=' + $(window).height() + '&width=' + $(window).width() + timeurlappend;
		this.$resized_widget[0].innerHTML = "<img src=\"" + imageurl +  "\" ondblclick=parent.location='" + linkurl + "'><span class='gs-resize-handle gs-resize-handle-both'></span> ";
			//$(id_name)[0].innerHTML = "<img src=\"" + newgraphurl +  "\"/><span class='gs-resize-handle gs-resize-handle-both'></span> ";
   		var gridData = JSON.stringify(gridstervar.serialize());
		console.log(gridData);
		localStorage.setItem('griddata', gridData);
	   },
	},
	serialize_params: function($w, wgd) { 
                   return { 
                           id: wgd.el[0].id, 
                           col: wgd.col, 
                           row: wgd.row, 
                           size_x: wgd.size_x, 
                           size_y: wgd.size_y 
                    };
        },
	draggable: {
			stop: function(event, ui) {
	        		var gridData = JSON.stringify(gridstervar.serialize());
				console.log(gridData);
				localStorage.setItem('griddata', gridData);
			},
	},
    })

        gridstervar = $(".gridster ul").gridster( {
	}).data('gridster');
});

</script>
{% endblock %}
